<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- JQuery -->
    <script src="node_modules/jquery/dist/jquery.js"></script>
    <link rel="icon" href="assets/icon.ico">
    <!-- CodeMirror -->
    <script src="node_modules/codemirror/lib/codemirror.js"></script>
    <link rel="stylesheet" href="node_modules/codemirror/lib/codemirror.css">
    <link rel="stylesheet" href="node_modules/codemirror/theme/material-darker.css">
    <link rel="stylesheet" href="node_modules/codemirror/theme/base16-light.css">
    <script src="node_modules/codemirror/addon/mode/simple.js"></script>
    <script src="node_modules/codemirror/addon/edit/closebrackets.js"></script>
    <!-- PaginationJS -->
    <script src="node_modules/paginationjs/dist/pagination.js"></script>
    <link rel="stylesheet" href="node_modules/paginationjs/dist/pagination.css">
    <!-- TippyJS -->
    <script src="node_modules/@popperjs/core/dist/umd/popper.min.js"></script>
    <script src="node_modules/tippy.js/dist/tippy-bundle.umd.js"></script>
    <link rel="stylesheet" href="node_modules/tippy.js/dist/tippy.css">
    <link rel="stylesheet" href="node_modules/tippy.js/themes/light.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="node_modules/@fortawesome/fontawesome-free/css/all.css">
    <!-- Ripplet.js -->
    <script src="node_modules/ripplet.js/umd/ripplet-declarative.min.js"></script>
    <!-- Style -->
    <link rel="stylesheet" href="style.css">
    <title>REmatch</title>
</head>

<body class="container nite">
    <!-- BEGIN EXPORT OVERLAY -->
    <div id="exportOverlay" class="fullOverlay">
        <div class="fullOverlayContainer" style="background-color: rgb(50,50,50);">
            <button 
                class="BtC3"
                onclick="exportResults('csv')">
                <i 
                    class="fas fa-lg fa-file-csv" 
                    style="margin-right: .5rem;">
                </i>
                csv wrap
            </button>
            <button 
                class="BtC2"
                onclick="exportResults('json')">
                { } json wrap
            </button>
            <button 
                class="BtC1"
                onclick="exportResults('plain')">
                <i 
                class="fas fa-lg fa-file-alt" 
                style="margin-right: .5rem;">
                </i>
                Plain wrap
            </button>
            <div id="formatEditor"></div>
        </div>
    </div>
    <!-- END EXPORT OVERLAY -->
    <!-- BEGIN EXAMPLES OVERLAY -->
    <div id="examplesOverlay" class="fullOverlay">
        <div class="fullOverlayContainer" style="background-color: rgb(50,50,50);">
            aaa
        </div>
    </div>
    <!-- END EXAMPLES OVERLAY -->

    <div class="buttonContainer">
        <img class="logo-dark" src="assets/logo-dark.png" alt="!RE{match}"/>
        <img class="logo-light" src="assets/logo-light.png" alt="!RE{match}"/>
        <input id="fileInput" type="file" onchange="handleFiles(this.files[0])" />
        <button 
            data-ripplet="color: rgba(255,255,255,.4)" 
            id="buttonQuery" type="button" class="btC2" 
            onclick="runQuery()">
                <i 
                    class="fas fa-lg fa-play" 
                    style="margin-right: .5rem;">
                </i>
            Query
        </button>
        <button 
            data-ripplet="color: rgba(255,255,255,.4)" 
            id="buttonFile" 
            type="button" 
            class="btC1" 
            onclick="$('#fileInput').click()">
                <i 
                    class="fas fa-lg fa-folder-open" 
                    style="margin-right: .5rem;">
                </i>
            Open
        </button>
        <button 
            data-ripplet="color: rgba(255,255,255,.4)" 
            id="buttonExport" 
            type="button" 
            class="btC3">
                <i
                    class="fas fa-lg fa-download" 
                    style="margin-right: .5rem;">
                </i>
            Export
        </button>
        <button 
            data-ripplet="color: rgba(255,255,255,.4)" 
            id="buttonExamples" 
            type="button" 
            class="btC4">
                <i 
                    class="fas fa-lg fa-lightbulb" 
                    style="margin-right: .5rem;">
                </i>
            Examples
        </button>
        <!--<button data-ripplet="color: rgba(255,255,255,.4)" type="button" class="btC5"><i class="fas fa-lg fa-cogs" style="margin-right: .5rem;"></i>About</button>-->
        <button 
            id="themeSelector" 
            type="button" 
            class="btTheme" 
            onclick="switchTheme()">
                <i 
                    class="fas fa-lg fa-moon">
                </i>
        </button>
    </div>

    <div id="queryEditor"></div>
    <div id="textEditor">
        <div class="editorOverlay">
            <div>
                <img src="https://samherbert.net/svg-loaders/svg-loaders/grid.svg" alt="Loading..."/>
                <div id="loadingPercent"></div>
            </div>
        </div>
    </div>

    <div class="results">
        <div id="paginationContainer"></div>
        <div id="dataContainer"></div>
    </div>
</body>

<script>
    /* BEGIN GLOBAL */
    const CHUNKSIZE = 1*10**8; // 100MB
    let schema = [];
    let lastTooltip = false;

    let SKIN = localStorage.SKIN;
    let TIPPY = localStorage.TIPPY;
    let CMSKIN = localStorage.CMSKIN;
    if (!SKIN || !TIPPY || !CMSKIN) {
        localStorage.SKIN = "nite";
        localStorage.TIPPY = "light";
        localStorage.CMSKIN = "cm-s-material-darker"
    }
    /* END GLOBAL */

    function runWorker() {
        console.log("%cWork started!", "color: red");
        workerWASM.postMessage({text: TextEditor.getValue(), query: `.*${QueryEditor.getValue()}.*`});
    }

    function workStart() {
        console.log("%cWorker is waiting for tasks :)", "color: orange");
        workerWASM = new Worker('work.js');
        workerWASM.addEventListener('message', (m) => {
            if (m.data.error) {
                console.log(`Error: ${m.data.error}`);
                alert(`Error: ${m.data.error}`);
                workerWASM.terminate();
            } else {
                console.log(m.data.log);
                workerWASM.terminate();
                console.log("%cWork finished!", "color: red");
                
                if (m.data.spans.length > 0) {
                    console.log("%cPrint started!", "color: cyan");
                    var t0 = Date.now();
                    schema = m.data.schema;
                    setResults(m.data.spans.slice(0, 1000));
                    console.log(`All matches printed in ${(Date.now() - t0) / 1000}s.`);
                    console.log("%cPrint finished!", "color: cyan");
                } else {
                    $('#paginationContainer').html("");
                    $('#dataContainer').html("No matches.");
                }
            }
            workStart();
        });
    }
    workStart();    

    /* BEGIN THEMES */

    function loadTheme(skin, tippy, cmskin) {
        $('.container')[0].className = `container ${skin}`
            $('.CodeMirror').each( function() {
                this.className = `CodeMirror ${cmskin}`;                
            });
        SKIN = skin;
        TIPPY = tippy;
        CMSKIN = cmskin;
        localStorage.SKIN = skin;
        localStorage.TIPPY = tippy;
        localStorage.CMSKIN = cmskin;
    }

    function switchTheme() {
        if (localStorage.SKIN == "nite") {
            loadTheme("lite", "default", "cm-s-base16-light");
        } else {
            loadTheme("nite", "light", "cm-s-material-darker");
        }
    }
    /* END THEMES */

    /* BEGIN CODEMIRROR */
    const TextEditor = CodeMirror($('#textEditor')[0], {
        mode: null,
        smartIndent: false,
        indentWithTabs: true,
        showInvisibles: true,
        lineWrapping: false,
        lineNumbers: true,
        firstLineNumber: 0,
        undoDepth: 100,
        value:
            `REmatch is cool!
REmatch is awesome!
REmatch is pretty!
REmatch is useful!
REmatch is cool!
REmatch is awesome!
REmatch is pretty!
REmatch is useful!
REmatch is cool!
REmatch is awesome!
REmatch is pretty!
REmatch is useful!`,
        viewportMargin: 10, // Lines rendered up and down [MEMORY]
    });

    CodeMirror.defineSimpleMode("rematchQuery", {
        start: [
            { regex: /(\.\+|\.\*|\.|\+)/, token: "keyword" },
            { regex: /(\\d)|(\\w)|(\\s)|(\\t)|(\\r)|(\\n)|(\\\()|(\\\))|(\\\[)|(\\\])|(\\\{)|(\\\})|(\\\.)|(\\\-)|(\\\_)/i, token: "string" },
            { regex: /(![A-Za-z0-9]+\{|\})/, token: "number" },
            { regex: /(\(|\)|\||\[|\]|\-)/, token: "operator" }
        ]
    });

    CodeMirror.defineSimpleMode("rematchFormat", {
        start: [
            { regex: /(\&[A-Za-z0-9]+)/, token: "number" },
        ]
    });

    const QueryEditor = CodeMirror($('#queryEditor')[0], {
        mode: "rematchQuery",
        showInvisibles: false,
        value: "!a{RE}!b{match} !c{is} !d{[a-z]+}!e{!}",
        autoCloseBrackets: true,
    });

    const FormatEditor = CodeMirror($('#formatEditor')[0], {
        mode: "rematchFormat",
        showInvisibles: false,
        value: "aa",
        autoCloseBrackets: false,
    });
    // Disables newline
    QueryEditor.on('beforeChange', function(instance, change) {
        var line = change.text.join("").replace(/\n/g, "");
        change.update(change.from, change.to, [line]);
        return true;
    });
    FormatEditor.on('beforeChange', function(instance, change) {
        var line = change.text.join("").replace(/\n/g, "");
        change.update(change.from, change.to, [line]);
        return true;
    });

    $('#queryEditor').keyup(function(e) {
        if (e.which === 13) {
            runQuery();
            return;
        }
    });
    
    loadTheme(localStorage.SKIN, localStorage.TIPPY, localStorage.CMSKIN);
    /* END CODEMIRROR */

    /* BEGIN PAGINATION */
    function paginate(content) {
        $('#paginationContainer').pagination({
            dataSource: content,
            pageSize: 9,
            showNavigator: true,
            showGoInput: true,
            showGoButton: true,
            callback: function (data, pagination) {
                var html = data.join("");
                $('#dataContainer').html(html);
            }
        });
    };

    function clearResults() {
        $('#paginationContainer').html("");
        $('#dataContainer').html("");
    };
    /* END PAGINATION */

    /* BEGIN FILE READER */
    async function handleFiles(file) {
        // IDEA: WebWorker that reads the file by chunks and send messages with them to main thread. (performance++) ??
        if (!file) {return};
        document.getElementById('buttonQuery').disabled = true;
        document.getElementById('buttonFile').disabled = true;
        $('#loadingPercent').html('Loading (0%)');
        $('.editorOverlay').css('visibility','visible');
        
        TextEditor.setValue("");
        clearResults();
        schema = [];
        $('#dataContainer').html("");

        var t0 = Date.now();
        
        var start = 0;
        var end = CHUNKSIZE;

        while (start < file.size) {
            var text = await file.slice(start, end).text()
                .then((text) => TextEditor.replaceRange(text, { line: Infinity }))
                .then(() => {
                    $('#loadingPercent').html(`Loading (${(start*100/file.size).toFixed()}%)`);
                    start = end;
                    end += CHUNKSIZE;
                })
        }
        document.getElementById('buttonQuery').disabled = false;
        document.getElementById('buttonFile').disabled = false;
        $('.editorOverlay').css('visibility','hidden');
        console.log(`Read '${file.name}' in ${(Date.now() - t0) / 1000}s. (about ${Math.round(file.size / 10 ** 6)}MB)`);
    };

    /* END FILE READER */

    /* BEGIN QUERY */
    function getSpanText(spans) {
        var textPreview = "";
        var curr = "";
        var count = 1;
        for (var i = 0; i < spans.length; i++) {
            curr = TextEditor.getRange(TextEditor.posFromIndex(spans[i][0]),
                TextEditor.posFromIndex(spans[i][1])
            );
            textPreview += `<span class="resultC${count}">${curr}</span>`
            count++;
        }
        return textPreview;
    };

    function setResults(data) {
        var buttonArr = [];
        for (var i = 0; i < data.length; i++) {
            buttonArr.push(`<div class="resultLine" data-spans="${data[i]}">${getSpanText(data[i])}</div>`);
        }
        paginate(buttonArr);
    };

    function runQuery() {
        TextEditor.setValue(TextEditor.getValue());
        clearResults();
        schema = [];

        runWorker();
    };

    /* END QUERY */

    /* BEGIN HIGHLIGHT */
    $(document).on('click', '.resultLine', function () {
        TextEditor.setValue(TextEditor.getValue());

        var arr = this.dataset.spans.split(",").map(Number);
        var start, end, markStart, markEnd, currClass;
        var colorId = 1;
        for (var i = 1; i < arr.length; i += 2) {
            currClass = `markC${colorId}`;
            start = arr[i - 1];
            end = arr[i];
            markStart = TextEditor.posFromIndex(start);
            markEnd = TextEditor.posFromIndex(end);
            TextEditor.markText(
                markStart,
                markEnd,
                {
                    className: currClass,
                    attributes: { "data-range": [start, end, colorId] },
                },
            );
            colorId++;
        }
        TextEditor.scrollIntoView(markStart, 200);
    });

    $(document).on('mouseenter', 'span[class*="markC"]', function () {
        var range = this.dataset.range.split(",").map(Number);
        //this.className += " outlined";
        $(`.${$.trim(this.className)}`).addClass('hovered');
        if (lastTooltip) {
            lastTooltip.destroy();
        }
        lastTooltip = tippy($(this)[0], {
            content: `<b>range:</b> [${range[0]}, ${range[1]})<br>
                      <hr>
                      <b>group:</b> #${range[2]} <b>${schema[range[2] - 1]}</b>`,
            allowHTML: true,
            maxWidth: 'none',
            duration: 0,
            theme: localStorage.TIPPY,
            placement: 'bottom',
        });
    });

    $(document).on('mouseleave', '.hovered', function() {
        $(`.${$.trim(this.className.replace('hovered', ''))}`).removeClass('hovered');
    })
    /* END HIGHLIGHT */

    /* BEGIN FULL OVERLAY */
    // Export
    $(document).on('click', '#buttonExport', function () {
        $('#exportOverlay').css('height', '100vh');
    });

    $(document).on('click', '#buttonExport', function () {
       // OJO $('.fullOverlay').css('height', '0')
    });
    // Examples
    $(document).on('click', '#buttonExamples', function () {
        $('#examplesOverlay').css('height', '100vh');
    });

    $(document).on('click', '#buttonExamples', function () {
       // OJO $('.fullOverlay').css('height', '0')
    });

    function exportResults(type) {
        if (type == 'csv') {
            alert('WIP');
        } else 
        if (type == 'json') {
            alert('WIP');
        // PLAIN
        } else {
            console.log();
        }
    }
    /* END FULL OVERLAY */



    /* BEGIN EGG */
    const cl = "cl"
    const mag = "mag"
    function egg(theme) {
        if (theme == cl) {
            loadTheme("cl", "light", "cm-s-base16-light");
        }
        if (theme == mag) {
            loadTheme("mag", "light", "cm-s-base16-light");
        }
    }
    /* END EGG */

</script>

</html>